name: 'Looker Janitor: LookML View Cleaner'
description: Tidy up Looker LookML view files by grouping, sorting and warning about inconsistencies.
author: 'Alhan Keser'

inputs:
  files:
    required: false
    type: string
    description: 'List of files to clean. If omitted, then any changed view files will be cleaned.'
    default: ''
  type_order:
    required: false
    type: string
    description: 'Order of field types.'
    default: |
      filter
      parameter
      dimension
      dimension_group
      measure
      set
  param_order:
    required: false
    type: string
    description: 'Order of field parameters.'
    default: |
      hidden
      type
      view_label
      group_label
      group_item_label
      label
      description
      sql
      sql_start
      sql_end
      value_format_name
      value_format
      filters
      drill_fields

outputs:
  warnings:
    description: 'List of warnings.'

runs:
  using: 'composite'
  steps:
    - name: Checkout Branch
      uses: actions/checkout@v2
      with:
        ref: ${{ github.event.pull_request.head.ref }}
    - name: Configure Git user
      run : |
        git config user.name github-actions
        git config user.email github-actions@github.com
      shell: bash
    - name: Checkout Looker Janitor
      uses: actions/checkout@v2
      with:
        repository: alhankeser/looker-janitor
        path: looker-janitor
        ref: main
    - name: Install Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.12
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r looker-janitor/requirements.txt
      shell: bash
    - name: Get Changed Files
      if: ${{ inputs.files == '' }}
      id: changed_files
      uses: tj-actions/changed-files@v44
      with:
        files: |
            **.view.lkml
            **.view.lookml
    - name: Get Files to Clean
      id: files_to_clean
      run: |
        if [ "${{ inputs.files }}" != "" ]; then
          files="${{ inputs.files }}"
        else
          files="${{ steps.changed_files.outputs.all_changed_files }}"
        fi
        echo "files=${files//$'\n'/ }" >> $GITHUB_OUTPUT
      shell: bash
    - name: Run Looker Janitor
      id: looker_janitor
      run: |
        
        type_order="${{ inputs.type_order }}"
        files="${{ steps.files_to_clean.outputs.files }}"
        param_order="${{ inputs.param_order }}"
        primary_key_first="${{ inputs.primary_key_first }}"
        order_by_label="${{ inputs.order_by_label }}"
        order_fields="${{ inputs.order_fields }}"
        order_field_parameters="${{ inputs.order_field_parameters }}"
        check_required_params="${{ inputs.check_required_params }}"
        required_filter="${{ inputs.required_filter }}"
        required_parameter="${{ inputs.required_parameter }}"
        required_dimension="${{ inputs.required_dimension }}"
        required_dimension_group="${{ inputs.required_dimension_group }}"
        required_measure="${{ inputs.required_measure }}"
        required_set="${{ inputs.required_set }}"

        type_order="${type_order//$'\n'/ }"
        files="${files//$'\n'/ }"
        param_order="${param_order//$'\n'/ }"
        primary_key_first="${primary_key_first//$'\n'/ }"
        order_by_label="${order_by_label//$'\n'/ }"
        order_fields="${order_fields//$'\n'/ }"
        order_field_parameters="${order_field_parameters//$'\n'/ }"
        check_required_params="${check_required_params//$'\n'/ }"
        required_filter="${required_filter//$'\n'/ }"
        required_parameter="${required_parameter//$'\n'/ }"
        required_dimension="${required_dimension//$'\n'/ }"
        required_dimension_group="${required_dimension_group//$'\n'/ }"
        required_measure="${required_measure//$'\n'/ }"
        required_set="${required_set//$'\n'/ }"

        echo "${{ param_order }}"

        python looker-janitor/main.py \
        --files ${{ steps.files_to_clean.outputs.files }} \
        --type_order ${{ type_order }} \ 
        --param_order "${{ param_order }}" \ 
        --primary_key_first ${primary_key_first} \ 
        --order_by_label ${order_by_label} \ 
        --order_fields ${order_fields} \ 
        --order_field_parameters ${order_field_parameters} \ 
        --check_required_params ${check_required_params} \ 
        --required_filter ${required_filter} \ 
        --required_parameter ${required_parameter} \ 
        --required_dimension ${required_dimension} \ 
        --required_dimension_group ${required_dimension_group} \ 
        --required_measure ${required_measure} \ 
        --required_set ${required_set}
      shell: bash
    - name: Commit Cleaned Files
      id: commit_changes
      run: |
        for file in ${{ steps.files_to_clean.outputs.files }}; do
            git add "${file}"
        done
        git commit -m "Run Looker Janitor" || continue
        git push
      shell: bash

branding:
  icon: check-square
  color: green
