name: 'Looker Janitor'
description: Clean and organize Looker lookml view.lkml files.
author: 'Alhan Keser'

inputs:
  files:
    description: 'List of files to clean. If omitted, then any changed view files will be cleaned.'
    type: string
    default: ''
    required: false

outputs:
  warnings:
    description: 'List of warnings.'

runs:
  using: 'composite'
  steps:
    - name: Checkout Branch
      uses: actions/checkout@v2
      with:
        ref: ${{ github.event.pull_request.head.ref }}
    - name: Configure Git user
      run : |
        git config user.name github-actions
        git config user.email github-actions@github.com
      shell: bash
    - name: Checkout Looker Janitor
      uses: actions/checkout@v2
      with:
        repository: alhankeser/looker-janitor
        path: looker-janitor
        ref: main
    - name: Install Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.12
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      shell: bash
    - name: Get Changed Files
      if: ${{ inputs.files == '' }}
      id: changed_files
      uses: tj-actions/changed-files@v44
      with:
        files: |
            **.view.lkml
            **.view.lookml
    - name: Get Files to Clean
      id: files_to_clean
      run: |
        if [ "${{ inputs.files }}" != "" ]; then
          echo "::set-output name=files::${{ inputs.files }}"
        else
          echo "::set-output name=files::${{ steps.changed_files.outputs.all_changed_files }}"
        fi
      shell: bash
    - name: Run Looker Janitor
      id: looker_janitor
      run: |
        python looker-janitor/main.py ${{ steps.files_to_clean.outputs.files }}
      shell: bash
    - name: Commit Cleaned Files
      id: commit_changes
      run: |
        for file in ${{ steps.files_to_clean.outputs.files }}; do
            git add "${file}"
        done
        git commit -m "Run Looker Janitor" || continue
        git push
      shell: bash

branding:
  icon: check-square
  color: green
